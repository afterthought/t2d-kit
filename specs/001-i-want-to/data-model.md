# Data Model: Multi-Framework Diagram Pipeline

**Date**: 2025-01-16
**Feature**: Multi-Framework Diagram Pipeline
**Branch**: 001-i-want-to

## Entity Relationship Diagram

```mermaid
erDiagram
    UserRecipe ||--|| ProcessedRecipe : "transforms into"
    UserRecipe ||--|| PRDContent : "contains"
    UserRecipe ||--|| UserInstructions : "contains"
    ProcessedRecipe ||--o{ ContentFile : "defines"
    ProcessedRecipe ||--o{ DiagramSpecification : "contains"
    ProcessedRecipe ||--o{ DiagramReference : "contains"
    ProcessedRecipe ||--|| OutputConfig : "has"
    DiagramSpecification ||--|| DiagramReference : "corresponds to"
    ContentFile ||--|| ClaudeAgent : "maintained by"
    ContentFile ||--o{ DiagramReference : "uses"
    DiagramSpecification ||--|| ClaudeAgent : "generated by"
    DiagramSpecification ||--|| FrameworkMapping : "uses"
    DiagramSpecification ||--|| DiagramOutput : "produces"
    OutputConfig ||--o| MkDocsConfig : "contains"
    OutputConfig ||--o| MarpConfig : "contains"
    MkDocsConfig ||--o{ ContentFile : "references"
    MarpConfig ||--o{ ContentFile : "references"
    ProcessedRecipe ||--|| ProcessingLog : "generates"
    ProcessingLog ||--o{ ProcessingEvent : "records"
    ClaudeAgent ||--|| MCPServer : "uses for YAML ops"
```

## Core Entities

### Base Model Configuration

All models inherit from T2DBaseModel with enhanced validation:

```python
from pydantic import BaseModel, ConfigDict, Field, field_validator, model_validator
from typing import Annotated

class T2DBaseModel(BaseModel):
    """Base model for all T2D-Kit entities with enhanced validation."""

    model_config = ConfigDict(
        extra='forbid',              # No unexpected fields
        validate_assignment=True,    # Validate on assignment
        str_strip_whitespace=True,   # Auto-strip strings
        frozen=False,               # Allow mutations
        use_enum_values=True,       # Use enum values in JSON
        json_schema_extra={
            "title": "T2D-Kit Models",
            "version": "1.0.0"
        }
    )

# Common type annotations
IdField = Annotated[str, Field(pattern=r'^[a-zA-Z0-9_-]+$', min_length=1, max_length=100)]
PathField = Annotated[str, Field(min_length=1, max_length=500)]
InstructionsField = Annotated[str, Field(min_length=10, max_length=10000)]
```

### UserRecipe (recipe.yaml)
**Purpose**: User-maintained recipe with PRD content and high-level instructions
**Source**: User-created YAML file
**Output**: Processed by Claude agent to generate ProcessedRecipe

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| name | string | Yes | Max 255 chars | Project/system name |
| version | string | No | Semantic version | Recipe version (default: 1.0.0) |
| prd | PRDContent | Yes | Valid PRD | Product requirements document |
| instructions | UserInstructions | Yes | Valid instructions | What to generate from PRD |
| preferences | Preferences | No | Valid prefs | User preferences for generation |
| metadata | Dict[str, Any] | No | JSON object | User-defined metadata |

### PRDContent
**Purpose**: Product Requirements Document content or reference
**Source**: Embedded in recipe.yaml or external file reference

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| content | string | Conditional | Max 1MB | Embedded PRD content directly in recipe |
| file_path | string | Conditional | Valid path | Path to local PRD file |
| format | PRDFormat | No | Enum | Format of PRD (markdown, text, html) |
| sections | List[string] | No | Section names | Key sections to focus on |

**Validation**: Must have either `content` OR `file_path` (exactly one)

**How PRD is Handled**:
1. **If `content` provided**: Transform agent uses directly
2. **If `file_path` provided**: Transform agent reads file using Read tool

**Note**: If the user needs to fetch a PRD from an external source (e.g., via MCP), they can:
- Invoke the transform command with instructions: `/t2d-transform recipe.yaml --fetch-prd-from "mcp__chat-prd__get_document UUID"`
- Or simply tell Claude: "First fetch PRD document UUID abc-123, then transform the recipe"
- The transform agent will handle fetching as part of its execution

**PRD Processing**:
Once the PRD content is obtained, the transform agent:
1. Analyzes the PRD content for system components, features, and requirements
2. Maps user diagram requests to specific diagram types
3. Generates detailed DiagramSpecification objects with prompts
4. Creates ContentFile specifications with base prompts
5. Writes the processed recipe.t2d.yaml via MCP

### UserInstructions
**Purpose**: High-level instructions for what to generate
**Source**: User-defined in recipe.yaml

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| diagrams | List[DiagramRequest] | Yes | Min 1 item | Requested diagram types |
| documentation | DocumentationInstructions | No | Valid config | Documentation generation guidance |
| presentation | PresentationInstructions | No | Valid config | Presentation generation guidance |
| focus_areas | List[string] | No | String list | PRD sections/features to emphasize |
| exclude | List[string] | No | String list | PRD sections/features to omit |

### DiagramRequest
**Purpose**: User's high-level diagram request
**Source**: User-defined, interpreted by agent

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| type | string | Yes | Free text | "architecture", "user flow", etc. |
| description | string | No | Max 500 chars | What should be shown |
| framework_preference | string | No | Framework hint | Preferred framework if any |

### DocumentationInstructions
**Purpose**: Guidance for markdown content generation
**Source**: User-defined, passed to content agents as prompts
**Usage**: Transform agent converts to specific prompts for markdown_maintainer and mkdocs_formatter

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| style | DocStyle | No | Enum | Writing style (technical, business, tutorial) |
| audience | string | No | Max 255 chars | Target audience (developers, stakeholders, etc.) |
| sections | List[string] | No | Section names | Requested sections (overview, api, deployment, etc.) |
| detail_level | DetailLevel | No | Enum | Level of detail (high-level, detailed, comprehensive) |
| include_code_examples | bool | No | Boolean | Whether to include code samples |
| include_diagrams_inline | bool | No | Boolean | Embed diagrams vs. link to them |

**Enums**:
```python
class DocStyle(Enum):
    TECHNICAL = "technical"      # Developer-focused, technical details
    BUSINESS = "business"        # Business-focused, less technical
    TUTORIAL = "tutorial"        # Step-by-step guide format
    REFERENCE = "reference"      # API/reference documentation

class DetailLevel(Enum):
    HIGH_LEVEL = "high-level"    # Executive summary level
    DETAILED = "detailed"        # Standard documentation
    COMPREHENSIVE = "comprehensive"  # Include all details
```

### PresentationInstructions
**Purpose**: Guidance for slide generation
**Source**: User-defined, passed to marp_slides agent as prompts
**Usage**: Transform agent converts to specific prompts for slide creation

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| audience | string | No | Max 255 chars | Target audience for presentation |
| max_slides | int | No | 5-100 | Maximum number of slides |
| style | PresentationStyle | No | Enum | Presentation style |
| include_speaker_notes | bool | No | Boolean | Generate speaker notes |
| emphasis_points | List[string] | No | String list | Key points to emphasize |
| time_limit | int | No | Minutes | Target presentation duration |

**Enums**:
```python
class PresentationStyle(Enum):
    EXECUTIVE = "executive"      # High-level for executives
    TECHNICAL = "technical"      # Technical deep-dive
    SALES = "sales"             # Sales/marketing focus
    WORKSHOP = "workshop"        # Interactive workshop format
```

### ProcessedRecipe (recipe.t2d.yaml)
**Purpose**: Agent-generated recipe with detailed specifications
**Source**: Generated by Claude agent from UserRecipe
**Usage**: Used by orchestrator for actual generation

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| name | string | Yes | From UserRecipe | Project name |
| version | string | Yes | Semantic version | Recipe version |
| source_recipe | string | Yes | File path | Path to original recipe.yaml |
| generated_at | datetime | Yes | ISO 8601 | When generated |
| content_files | List[ContentFile] | Yes | Valid paths | Generated content specifications |
| diagram_specs | List[DiagramSpecification] | Yes | Min 1 item | Detailed diagram specifications |
| diagram_refs | List[DiagramReference] | Yes | Min 1 item | Diagram references (1:1 with diagram_specs) |
| outputs | OutputConfig | Yes | Valid config | Output configuration |
| generation_notes | List[string] | No | String list | Notes from agent about decisions |

**State Transitions**:
- UserRecipe → (Agent Processing) → ProcessedRecipe
- ProcessedRecipe → Validated → Processing → Completed
- ProcessedRecipe → Validated → Processing → Failed

### ContentFile
**Purpose**: Markdown files maintained by Claude Code agents
**Source**: Created/maintained by Claude Code subagents

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| id | string | Yes | UUID or slug | Unique identifier |
| path | string | Yes | Valid path | Path to markdown file |
| type | ContentType | Yes | Enum | Type of content (documentation, presentation) |
| agent | string | Yes | Agent name | Claude Code agent responsible (t2d-markdown-maintainer, t2d-mkdocs-formatter, t2d-marp-slides) |
| base_prompt | string | Yes | Max 5KB | Base instructions WITHOUT diagram list (diagram context added dynamically) |
| diagram_refs | List[string] | Yes | Diagram IDs | List of diagram IDs available to this content |
| title | string | No | Max 255 chars | Content title |
| last_updated | datetime | Yes | ISO 8601 | Last update timestamp |

**Note**: The `base_prompt` contains instructions but NOT the diagram list. The orchestrator dynamically combines `base_prompt` with actual `DiagramReference` objects when invoking the content agent.

### DiagramReference
**Purpose**: Metadata about diagrams that will be available to content agents
**Source**: Created by transform agent in recipe.t2d.yaml, paths updated after generation
**Lifecycle**:
1. Transform agent creates with expected paths (e.g., "docs/assets/system.svg")
2. Orchestrator updates with actual paths after successful generation
3. Orchestrator passes to content agents dynamically at invocation

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| id | string | Yes | Diagram ID | References DiagramSpecification.id |
| title | string | Yes | Max 255 chars | Diagram title |
| type | DiagramType | Yes | Enum | Type of diagram (c4_container, sequence, etc.) |
| expected_path | string | Yes | Valid path | Expected path for generated diagram file |
| actual_paths | Dict[OutputFormat, str] | No | Format→path | Actual paths after generation (SVG, PNG, etc.) |
| description | string | No | Max 500 chars | What the diagram shows |
| status | GenerationStatus | Yes | Enum | pending, generated, failed |

**Enums**:
```python
class GenerationStatus(Enum):
    PENDING = "pending"      # Not yet generated
    GENERATED = "generated"  # Successfully generated
    FAILED = "failed"        # Generation failed
```

**Enums**:
```python
class ContentType(Enum):
    DOCUMENTATION = "documentation"
    PRESENTATION = "presentation"
```

### DiagramSpecification
**Purpose**: Individual diagram definition with generator agent prompt
**Source**: Generated by transform agent from user's diagram requests

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| id | string | Yes | UUID or slug | Unique identifier |
| type | DiagramType | Yes | Enum value | Diagram type (c4, sequence, erd, etc.) |
| framework | FrameworkType | No | Enum value | Target framework (auto-selected if empty) |
| agent | string | Yes | Agent name | Claude Code agent to invoke (e.g., 't2d-d2-generator', 't2d-mermaid-generator') |
| title | string | Yes | Max 255 chars | Diagram title |
| instructions | string | Yes | Max 5KB | Prompt for generator agent describing what to create |
| output_file | string | Yes | Valid path | Where to save the .d2/.mmd/.puml file |
| output_formats | List[OutputFormat] | Yes | Min 1 | Desired outputs (svg, png, pdf) |
| options | Dict[str, Any] | No | Framework-specific | Rendering options |

**Note**: The `instructions` field contains natural language prompts that tell the generator agent what diagram to create, NOT the actual D2/Mermaid/PlantUML syntax. The `agent` field specifies which Claude Code generator agent (t2d-d2-generator, t2d-mermaid-generator, etc.) will interpret these prompts and generate the appropriate syntax.

**Output Format Handling**: When multiple output formats are specified, the generator agent will either:
1. Pass all formats to the CLI in a single command if supported (e.g., some tools support multiple outputs)
2. Loop through formats and call the CLI multiple times (e.g., `d2 diagram.d2 diagram.svg` then `d2 diagram.d2 diagram.png`)

**Enums**:
```python
class DiagramType(Enum):
    C4_CONTEXT = "c4_context"
    C4_CONTAINER = "c4_container"
    C4_COMPONENT = "c4_component"
    SEQUENCE = "sequence"
    FLOWCHART = "flowchart"
    ERD = "erd"
    GANTT = "gantt"
    STATE = "state"
    NETWORK = "network"
    ARCHITECTURE = "architecture"
    CLASS = "class"
    CUSTOM = "custom"

class FrameworkType(Enum):
    D2 = "d2"
    MERMAID = "mermaid"
    PLANTUML = "plantuml"
    GRAPHVIZ = "graphviz"
    AUTO = "auto"

class OutputFormat(Enum):
    SVG = "svg"
    PNG = "png"
    PDF = "pdf"
    INLINE = "inline"
```

### FrameworkMapping
**Purpose**: Rules for routing diagram types to frameworks
**Source**: Configuration file + runtime overrides

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| diagram_type | DiagramType | Yes | Enum value | Type of diagram |
| primary_framework | FrameworkType | Yes | Enum value | Preferred framework |
| fallback_framework | FrameworkType | No | Enum value | Fallback if primary unavailable |
| compatibility_score | float | Yes | 0.0-1.0 | How well framework handles type |
| features_supported | List[str] | Yes | Feature list | Supported diagram features |

**Default Mappings**:
- C4_* → D2 (fallback: PlantUML)
- SEQUENCE → Mermaid (fallback: PlantUML)
- ERD → Mermaid (no fallback)
- GANTT → Mermaid (no fallback)
- ARCHITECTURE → D2 (fallback: Graphviz)
- FLOWCHART → Mermaid (fallback: Graphviz)
- STATE → Mermaid (fallback: PlantUML)
- NETWORK → D2 (fallback: Graphviz)

### DiagramOutput
**Purpose**: Generated diagram artifact
**Source**: Framework generator output

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| diagram_id | string | Yes | References DiagramSpec.id | Source diagram |
| source_file | string | Yes | Valid file path | Generated source (.d2, .mmd) |
| rendered_files | Dict[OutputFormat, str] | Yes | Min 1 entry | Format → file path mapping |
| generation_time | datetime | Yes | ISO 8601 | When generated |
| framework_version | string | Yes | Version string | Framework version used |
| warnings | List[str] | No | String list | Generation warnings |
| metadata | Dict[str, Any] | No | JSON object | Framework-specific metadata |

### OutputConfig
**Purpose**: Configuration for output generation referencing markdown files
**Source**: Recipe outputs section

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| assets_dir | string | Yes | Valid path | Asset output directory for diagrams |
| mkdocs | MkDocsConfig | No | Valid config | MkDocs site configuration |
| marp | MarpConfig | No | Valid config | Marp presentation configuration |

### MkDocsConfig
**Purpose**: MkDocs-specific configuration with markdown file references
**Source**: Recipe mkdocs section

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| config_file | string | Yes | Valid path | Path to mkdocs.yml |
| nav_structure | List[NavItem] | Yes | Navigation tree | Site navigation referencing markdown files |
| content_refs | List[string] | Yes | File paths | References to markdown content files |
| theme | string | No | Theme name | MkDocs theme (material, readthedocs, etc.) |
| plugins | List[string] | No | Plugin list | MkDocs plugins to enable |

### MarpConfig
**Purpose**: Marp-specific configuration with markdown file references
**Source**: Recipe marp section

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| slide_files | List[string] | Yes | File paths | References to markdown slide files |
| theme | string | No | Theme name | Marp theme (default, gaia, uncover) |
| paginate | bool | No | Boolean | Add page numbers |
| export_pdf | bool | No | Boolean | Export to PDF |
| export_pptx | bool | No | Boolean | Export to PowerPoint |
| export_html | bool | No | Boolean | Export to HTML (default: true) |

**Enums**:
```python
class TemplateType(Enum):
    DEFAULT = "default"
    GITHUB = "github"
    GITLAB = "gitlab"
    CONFLUENCE = "confluence"
    MKDOCS = "mkdocs"
    MARP = "marp"
    CUSTOM = "custom"  # Requires template_path

class Platform(Enum):
    GITHUB = "github"
    GITLAB = "gitlab"
    BITBUCKET = "bitbucket"
    CONFLUENCE = "confluence"
    STATIC_SITE = "static"
    MKDOCS = "mkdocs"
    MARP = "marp"
```

### PresentationConfig
**Purpose**: Marp presentation generation settings
**Source**: Recipe presentation section

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| output_file | string | Yes | Valid path | Presentation markdown output |
| theme | string | No | Theme name | Marp theme (default, gaia, uncover) |
| paginate | bool | No | Boolean | Add page numbers |
| slides | List[SlideSpec] | No | Slide list | Explicit slide definitions |
| auto_split | bool | No | Boolean | Auto-split by headers |
| export_pdf | bool | No | Boolean | Export to PDF |
| export_pptx | bool | No | Boolean | Export to PowerPoint |
| export_html | bool | No | Boolean | Export to HTML |

### SlideSpec
**Purpose**: Individual slide configuration for presentations
**Source**: Presentation slide definitions

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| title | string | Yes | Max 255 chars | Slide title |
| content | string | No | Markdown | Slide content |
| diagram_ids | List[string] | No | Valid IDs | Diagrams to include |
| layout | SlideLayout | No | Enum | Slide layout style |
| speaker_notes | string | No | Markdown | Speaker notes |

**Enums**:
```python
class SlideLayout(Enum):
    TITLE = "title"
    CONTENT = "content"
    TWO_COLUMN = "two-column"
    IMAGE_FOCUS = "image-focus"
    COMPARISON = "comparison"
```

### OutputAsset
**Purpose**: Generated file tracking
**Source**: Documentation builder output

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| id | string | Yes | UUID | Unique asset ID |
| file_path | string | Yes | Valid path | Absolute file path |
| asset_type | AssetType | Yes | Enum value | Type of asset |
| size_bytes | int | Yes | Positive int | File size |
| checksum | string | Yes | SHA256 | File checksum |
| created_at | datetime | Yes | ISO 8601 | Creation timestamp |
| references | List[str] | No | Path list | Files referencing this asset |

**Enums**:
```python
class AssetType(Enum):
    MARKDOWN = "markdown"
    DIAGRAM_SOURCE = "diagram_source"
    SVG = "svg"
    PNG = "png"
    PDF = "pdf"
    CONFIG = "config"
    PRESENTATION = "presentation"
    SLIDE_DECK = "slide_deck"
```

### ProcessingLog
**Purpose**: Recipe execution tracking and diagnostics
**Source**: Pipeline execution

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| id | string | Yes | UUID | Log entry ID |
| recipe_name | string | Yes | From Recipe | Recipe being processed |
| started_at | datetime | Yes | ISO 8601 | Start timestamp |
| completed_at | datetime | No | ISO 8601 | Completion timestamp |
| status | ProcessingStatus | Yes | Enum value | Current status |
| events | List[ProcessingEvent] | Yes | Event list | Processing events |
| summary | ProcessingSummary | No | On completion | Execution summary |

### ProcessingEvent
**Purpose**: Individual processing step tracking
**Source**: Pipeline stages

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| timestamp | datetime | Yes | ISO 8601 | Event time |
| event_type | EventType | Yes | Enum value | Type of event |
| component | string | Yes | Component name | Source component |
| message | string | Yes | Max 1KB | Event description |
| severity | Severity | Yes | Enum value | Event severity |
| context | Dict[str, Any] | No | JSON object | Additional context |

**Enums**:
```python
class ProcessingStatus(Enum):
    PENDING = "pending"
    VALIDATING = "validating"
    ROUTING = "routing"
    GENERATING = "generating"
    RENDERING = "rendering"
    BUILDING = "building"
    COMPLETED = "completed"
    FAILED = "failed"

class EventType(Enum):
    START = "start"
    VALIDATION = "validation"
    ROUTING = "routing"
    GENERATION = "generation"
    RENDERING = "rendering"
    OUTPUT = "output"
    WARNING = "warning"
    ERROR = "error"
    COMPLETE = "complete"

class Severity(Enum):
    DEBUG = "debug"
    INFO = "info"
    WARNING = "warning"
    ERROR = "error"
    CRITICAL = "critical"
```

### ProcessingSummary
**Purpose**: Execution summary statistics
**Source**: Computed from ProcessingLog

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| total_diagrams | int | Yes | Non-negative | Total diagrams processed |
| successful_diagrams | int | Yes | Non-negative | Successfully generated |
| failed_diagrams | int | Yes | Non-negative | Failed generation |
| total_assets | int | Yes | Non-negative | Total files created |
| execution_time_ms | int | Yes | Positive | Total execution time |
| warnings_count | int | Yes | Non-negative | Total warnings |
| errors | List[str] | No | Error list | Error messages |

### ClaudeAgent
**Purpose**: Claude Code agents that process recipes and generate content
**Source**: Agent definitions in agents/ directory

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| name | string | Yes | Agent name | Agent identifier (t2d-transform, t2d-orchestrate, etc.) |
| type | AgentType | Yes | Enum | Type of agent |
| description | string | Yes | Max 500 chars | Agent purpose |
| tools | List[string] | Yes | Tool names | Available tools (Read, Write, Bash, MCP) |
| prompt_file | string | Yes | File path | Path to agent prompt markdown |

**Enums**:
```python
class AgentType(Enum):
    TRANSFORM = "transform"  # recipe.yaml → recipe.t2d.yaml
    ORCHESTRATE = "orchestrate"  # Process recipe.t2d.yaml
    GENERATOR = "generator"  # Generate diagrams (d2, mermaid, plantuml)
    CONTENT = "content"  # Maintain markdown files
```

### MCPServer
**Purpose**: MCP server that provides file operations for Claude agents
**Source**: MCP server configuration

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| name | string | Yes | Server name | MCP server identifier (t2d-kit) |
| working_dir | string | Yes | Valid path | Working directory for recipes |
| tools | List[MCPTool] | Yes | Tool list | Available MCP tools |
| resources | List[MCPResource] | Yes | Resource list | Recipe resources |

### MCPTool
**Purpose**: Individual MCP tool provided by server
**Source**: MCP server implementation

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| name | string | Yes | Tool name | Tool identifier (e.g., "read_user_recipe", "write_processed_recipe") |
| description | string | Yes | Max 500 chars | Tool purpose and usage |
| parameters | Dict[str, Any] | Yes | JSON Schema | Tool parameter schema |
| returns_validation | bool | Yes | Boolean | Whether output is Pydantic-validated |

**Available MCP Tools**:
- `read_user_recipe`: Read and validate recipe.yaml files
- `write_processed_recipe`: Write and validate recipe.t2d.yaml files
- `list_recipes`: List available recipe files
- `validate_recipe`: Validate a recipe without writing
- `analyze_recipe`: Analyze recipe structure and provide insights
- `suggest_enhancements`: Suggest recipe improvements (PDF, PPT, missing diagrams)

### MCPResource
**Purpose**: Recipe files exposed as MCP resources for easy access
**Source**: MCP server scans working directory

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| uri | string | Yes | URI format | Resource URI (e.g., "recipe://my-project/recipe.yaml") |
| name | string | Yes | Max 255 chars | Human-readable resource name |
| path | string | Yes | Valid path | File system path to recipe |
| type | ResourceType | Yes | Enum | Type of resource (user_recipe, processed_recipe) |
| last_modified | datetime | Yes | ISO 8601 | When file was last modified |

**Enums**:
```python
class ResourceType(Enum):
    USER_RECIPE = "user_recipe"      # recipe.yaml files
    PROCESSED_RECIPE = "processed_recipe"  # recipe.t2d.yaml files
```

## Relationships

### UserRecipe → ProcessedRecipe (1:1)
- User recipe is transformed into processed recipe by Claude agent
- One-to-one transformation preserves intent

### ProcessedRecipe → DiagramSpecification (1:N)
- Processed recipe contains one or more diagram specifications
- Diagrams are processed in parallel where possible
- Order preserved for documentation generation

### ProcessedRecipe → ContentFile (1:N)
- Processed recipe defines content files to be created
- Each content file maintained by specific Claude agent
- Files referenced by both MkDocs and Marp

### ProcessedRecipe → DiagramReference (1:N)
- Processed recipe contains diagram references created by transform agent
- One DiagramReference per DiagramSpecification (1:1 correspondence)
- DiagramReferences track expected paths and status

### DiagramSpecification → DiagramReference (1:1)
- Each DiagramSpecification has exactly one corresponding DiagramReference
- Transform agent creates both simultaneously
- DiagramReference tracks the lifecycle (pending → generated/failed)
- Orchestrator updates DiagramReference.actual_paths after generation

### ContentFile → DiagramReference (N:M)
- Content files reference multiple diagram references via diagram_refs list
- Orchestrator dynamically provides DiagramReference objects to content agents
- Content agents receive diagram context with actual paths at invocation time

### ContentFile → ClaudeAgent (N:1)
- Each content file maintained by a Claude agent
- Agents: t2d-markdown-maintainer, t2d-mkdocs-formatter, t2d-marp-slides
- Agent determines content structure and formatting

### DiagramSpecification → ClaudeAgent (N:1)
- Each diagram generated by appropriate Claude agent
- Generator agents: t2d-d2-generator, t2d-mermaid-generator, t2d-plantuml-generator
- Agent uses CLI tools (d2, mmdc, plantuml) for generation

### ClaudeAgent → MCPServer (N:1)
- Transform agent uses MCP to:
  - Read user recipes (recipe.yaml) with validation
  - Write processed recipes (recipe.t2d.yaml) with validation
- Orchestrator uses MCP to read processed recipes (recipe.t2d.yaml)
- MCP provides YAML validation with Pydantic for both recipe types
- Generator and content agents use their own Write/Read tools directly
- Build steps use Bash tool to run CLI commands
- MCP tools are only for YAML operations, not general file operations

### DiagramSpecification → FrameworkMapping (N:1)
- Each diagram type maps to a primary framework
- Fallback framework used if primary unavailable
- User overrides take precedence

### DiagramSpecification → DiagramOutput (1:1)
- Each specification produces one output
- Output may contain multiple file formats
- Failed generations have partial output

### DocumentationConfig → OutputAsset (1:N)
- Configuration drives asset generation
- Assets include markdown, images, configs
- All assets tracked for management

### ProcessingLog → ProcessingEvent (1:N)
- Log contains chronological event stream
- Events track pipeline progress
- Errors and warnings captured

## Instruction Transformation

### How User Instructions Become Agent Prompts

The transform agent (t2d-transform) converts high-level user instructions into specific prompts for content agents:

#### Documentation Instructions → Agent Prompts
```yaml
# User provides (in recipe.yaml):
documentation:
  style: "technical"
  audience: "developers"
  detail_level: "detailed"
  include_code_examples: true

# Transform agent generates (in recipe.t2d.yaml):
content_files:
  - agent: t2d-markdown-maintainer
    base_prompt: |
      Create technical documentation for developers.
      Include detailed explanations with code examples.
      Style: Technical reference format
      Embed diagrams where appropriate in the documentation.
      Use markdown image syntax: ![alt text](path)
    diagram_refs: ["system-architecture", "shopping-flow", "database-erd"]

diagram_refs:
  - id: system-architecture
    title: "E-Commerce Microservices Architecture"
    type: c4_container
    expected_path: docs/assets/system-architecture.svg
    status: pending
  - id: shopping-flow
    title: "User Shopping Flow"
    type: sequence
    expected_path: docs/assets/shopping-flow.svg
    status: pending
  - id: database-erd
    title: "E-Commerce Database Schema"
    type: erd
    expected_path: docs/assets/database-erd.svg
    status: pending

# When orchestrator invokes the content agent, it dynamically combines:
# 1. The base_prompt from ContentFile
# 2. The DiagramReference objects (with updated actual_paths after generation)
# Creating the full prompt at invocation time
```

#### Presentation Instructions → Agent Prompts
```yaml
# User provides:
presentation:
  audience: "executives"
  max_slides: 20
  style: "executive"
  emphasis_points: ["ROI", "Timeline"]

# Transform agent generates:
content_files:
  - agent: t2d-marp-slides
    base_prompt: |
      Create executive presentation for executives.
      Maximum 20 slides.
      Emphasize: ROI, Timeline
      Style: High-level overview, avoid technical details
    diagram_refs: ["system-architecture", "timeline-gantt"]
```

#### Focus Areas and Exclusions
These modify all agent prompts:
- **focus_areas**: Added to prompts as "Focus on: [areas]"
- **exclude**: Added to prompts as "Avoid mentioning: [items]"

### Workflow Order and Tool Usage

The orchestrator processes recipes in this order:

0. **Recipe transformation** (transform agent creates recipe.t2d.yaml)
   - Transform agent reads recipe.yaml
   - Creates DiagramSpecification objects with agent assignments
   - Creates DiagramReference objects with expected paths (status: pending)
   - Creates ContentFile objects with base_prompt and diagram_refs
   - Writes recipe.t2d.yaml via MCP

1. **Generate diagram source files** (parallel execution by generator agents)
   - Each generator agent receives the `instructions` prompt
   - Agent interprets the prompt and creates the diagram syntax
   - Agent uses **Write tool** to save .d2/.mmd/.puml file
   - Example: t2d-d2-generator writes "architecture.d2"

2. **Build diagram assets** (orchestrator runs all CLI tools via Bash)
   - The orchestrator uses **Bash tool** to run diagram CLI commands:
     - For single format: `d2 diagram.d2 diagram.svg`
     - For multiple formats, either:
       - Single command: `d2 diagram.d2 --format=svg,png` (if tool supports)
       - Multiple commands: `d2 diagram.d2 diagram.svg` then `d2 diagram.d2 diagram.png`
     - Mermaid: `mmdc -i diagram.mmd -o diagram.svg` (then repeat for PNG if needed)
     - PlantUML: `java -jar plantuml.jar -tsvg diagram.puml` and `-tpng` for PNG
   - Updates DiagramReference objects:
     - Sets actual_paths with real file locations
     - Updates status to "generated" or "failed"

3. **Create content files** with diagram context (content agents write markdown)
   - Orchestrator dynamically creates full prompt by combining:
     - ContentFile.base_prompt (instructions without diagram list)
     - DiagramReference objects for ContentFile.diagram_refs (with actual paths)
   - Content agents receive the combined prompt with actual diagram paths
   - Agents use **Write tool** to save markdown files
   - Markdown files reference the generated SVG/PNG files
   - Example: t2d-markdown-maintainer writes "content/overview.md"

4. **Generate final outputs** (orchestrator runs documentation tools via Bash)
   - The orchestrator uses **Bash tool** to run:
     - `mkdocs build` to generate MkDocs site
     - `marp content/slides.md -o presentation.html` for HTML presentations
     - `marp content/slides.md --pdf` for PDF export
     - `marp content/slides.md --pptx` for PowerPoint export
   - Creates final documentation site and presentation files

### Tool Usage Summary
- **MCP tools**: Read/write/validate recipe YAML files (recipe.yaml, recipe.t2d.yaml)
- **Write tool**: Create source files (.d2, .mmd, .puml) and markdown files
- **Bash tool**: Run CLI commands (d2, mmdc, plantuml) to build diagrams
- **Read tool**: Read PRD files, existing content, etc.

#### Example: Complete Diagram Workflow
```
Step 1 - Generator Agent (t2d-d2-generator):
  Input:
    agent: "t2d-d2-generator"
    instructions: "Create a C4 Container diagram showing microservices..."
    output_file: "docs/assets/system.d2"
    output_formats: ["svg", "png"]

  Agent Actions:
    1. Interprets the instructions
    2. Creates D2 syntax in memory
    3. Uses Write tool: Write("docs/assets/system.d2", d2_content)

  Output:
    File written: "docs/assets/system.d2"

Step 2 - Build Step (orchestrator handles multiple formats):
  For multiple output formats, orchestrator either:

  Option A - Multiple CLI calls:
    Bash("d2 docs/assets/system.d2 docs/assets/system.svg")
    Bash("d2 docs/assets/system.d2 docs/assets/system.png --format png")

  Option B - Single CLI call (if tool supports):
    Bash("d2 docs/assets/system.d2 --outputs docs/assets/system.svg,docs/assets/system.png")

  Output:
    Files created by d2 CLI:
    - "docs/assets/system.svg"
    - "docs/assets/system.png"

Step 3 - Content Generation (t2d-markdown-maintainer):
  Orchestrator dynamically constructs prompt:
    base_prompt (from ContentFile): "Create technical documentation..."
    +
    diagram_context (from DiagramReferences with actual_paths):
      "Available diagrams:
       1. system-architecture (C4 Container): E-Commerce Architecture
          SVG: docs/assets/system.svg
          PNG: docs/assets/system.png
       2. shopping-flow (Sequence): Shopping Flow
          SVG: docs/assets/shopping-flow.svg"

  Input to Agent:
    agent: "t2d-markdown-maintainer"
    combined_prompt: [base_prompt + formatted diagram list]

  Agent Actions:
    1. Creates markdown content
    2. Embeds diagrams: ![Architecture](docs/assets/system.svg)
    3. Uses Write tool: Write("content/overview.md", markdown_content)

  Output:
    File written: "content/overview.md"
```

## Validation Rules

### Recipe Validation
1. Must have at least one diagram specification
2. PRD content OR reference required (not both)
3. Documentation config must specify valid paths
4. Recipe name must be unique within project

### DiagramSpecification Validation
1. ID must be unique within recipe
2. Framework auto-selected if not specified
3. Instructions required for generation
4. Output formats must be supported by framework

### Path Validation
1. All paths must be valid for target OS
2. Output directories created if not exist
3. No path traversal attacks (../ blocked)
4. Asset paths relative to assets_dir

### Size Constraints
1. Recipe file: Max 10MB
2. PRD content: Max 1MB
3. Instructions: Max 50KB per diagram
4. Total output: Warning at 100MB

## Indexes and Performance

### Primary Indexes
- Recipe.name (unique)
- DiagramSpecification.id (unique within recipe)
- OutputAsset.file_path (unique)
- ProcessingLog.id (unique)

### Query Patterns
1. Find recipe by name → O(1)
2. Get diagrams for recipe → O(n)
3. Check framework compatibility → O(1)
4. List assets for documentation → O(n)
5. Get processing events for log → O(n)

### Caching Strategy
1. Framework mappings cached at startup
2. Templates cached after first use
3. Rendered diagrams cached for 30 days
4. Recipe validation results cached

## Migration and Versioning

### Schema Version
- Current: 1.0.0
- Version stored in recipe
- Backward compatibility for 2 major versions

### Migration Strategy
1. New fields: Add with defaults
2. Removed fields: Deprecate first
3. Type changes: Provide converters
4. Breaking changes: Major version bump

---
*Data model defined: 2025-01-16*