# Data Model: MCP Resources and Tools for Recipe Management

**Date**: 2025-09-18
**Feature**: User Recipe File Management
**Branch**: 002-the-user-can

## Entity Definitions

### MCP Resource Entities

#### DiagramTypeResource
Represents available diagram types that can be used in recipes.

```python
from typing import List, Dict, Any, Optional
from pydantic import BaseModel, Field

class DiagramTypeInfo(BaseModel):
    """Information about a diagram type."""
    type_id: str = Field(..., description="Unique identifier for the diagram type")
    name: str = Field(..., description="Human-readable name")
    framework: str = Field(..., description="Recommended framework (mermaid, d2, plantuml)")
    description: str = Field(..., description="What this diagram type is used for")
    example_usage: str = Field(..., description="Example description for this type")
    supported_frameworks: List[str] = Field(..., description="All frameworks that support this type")

class DiagramTypesResource(BaseModel):
    """Resource containing all available diagram types."""
    diagram_types: List[DiagramTypeInfo]
    total_count: int
    categories: Dict[str, List[str]] = Field(..., description="Types grouped by category")
```

#### RecipeResource
Represents existing recipes available in the system.

```python
class RecipeSummary(BaseModel):
    """Summary information for a recipe."""
    name: str = Field(..., description="Recipe name")
    file_path: str = Field(..., description="Path to recipe file")
    created_at: str = Field(..., description="ISO timestamp of creation")
    modified_at: str = Field(..., description="ISO timestamp of last modification")
    size_bytes: int = Field(..., description="File size in bytes")
    diagram_count: int = Field(..., description="Number of diagrams defined")
    has_prd: bool = Field(..., description="Whether PRD content is included")
    validation_status: str = Field(..., description="valid, invalid, or unknown")

class RecipeListResource(BaseModel):
    """Resource containing list of recipes."""
    recipes: List[RecipeSummary]
    total_count: int
    directory: str = Field(..., description="Recipe directory path")

class RecipeDetailResource(BaseModel):
    """Resource containing full recipe details."""
    name: str
    content: Dict[str, Any] = Field(..., description="Parsed YAML content")
    raw_yaml: str = Field(..., description="Raw YAML text")
    validation_result: Optional['ValidationResult']
    file_path: str
    metadata: RecipeSummary
```

#### RecipeSchemaResource
Provides the schema for creating valid recipes.

```python
class SchemaField(BaseModel):
    """Schema field definition."""
    name: str
    type: str
    required: bool
    description: str
    default: Optional[Any] = None
    constraints: Optional[Dict[str, Any]] = None
    example: Optional[Any] = None

class RecipeSchemaResource(BaseModel):
    """Resource containing recipe schema information."""
    version: str = Field(..., description="Schema version")
    fields: List[SchemaField]
    examples: Dict[str, Any] = Field(..., description="Example recipes")
    validation_rules: List[str] = Field(..., description="Validation rule descriptions")
```

### Processed Recipe Entities

#### ProcessedRecipeResource
Represents processed recipes generated by the transform agent.

```python
class ProcessedRecipeSummary(BaseModel):
    """Summary information for a processed recipe."""
    name: str = Field(..., description="Recipe name")
    file_path: str = Field(..., description="Path to processed recipe file")
    source_recipe: str = Field(..., description="Source user recipe name")
    generated_at: str = Field(..., description="ISO timestamp of generation")
    modified_at: str = Field(..., description="ISO timestamp of last modification")
    size_bytes: int = Field(..., description="File size in bytes")
    diagram_count: int = Field(..., description="Number of diagrams specified")
    content_file_count: int = Field(..., description="Number of content files")
    validation_status: str = Field(..., description="valid, invalid, or unknown")

class ProcessedRecipeListResource(BaseModel):
    """Resource containing list of processed recipes."""
    recipes: List[ProcessedRecipeSummary]
    total_count: int
    directory: str = Field(..., description="Processed recipe directory path")

class ProcessedRecipeDetailResource(BaseModel):
    """Resource containing full processed recipe details."""
    name: str
    content: Dict[str, Any] = Field(..., description="Parsed YAML content")
    raw_yaml: str = Field(..., description="Raw YAML text")
    validation_result: Optional['ValidationResult']
    file_path: str
    metadata: ProcessedRecipeSummary
```

### MCP Tool Entities

#### Recipe Creation/Modification Models

```python
from typing import Annotated
from pydantic import BaseModel, Field, validator

class PRDContent(BaseModel):
    """PRD content specification for recipe creation."""
    content: Optional[str] = Field(None, max_length=1048576, description="Embedded PRD content (max 1MB)")
    file_path: Optional[str] = Field(None, description="Path to external PRD file")
    format: str = Field("markdown", description="Content format (markdown or text)")

    @validator('content', 'file_path')
    def validate_content_source(cls, v, values):
        """Ensure exactly one content source is provided."""
        if values.get('content') and values.get('file_path'):
            raise ValueError("Cannot specify both content and file_path")
        if not values.get('content') and not values.get('file_path'):
            raise ValueError("Must specify either content or file_path")
        return v

class DiagramRequest(BaseModel):
    """Diagram specification in a recipe."""
    type: str = Field(..., description="Diagram type (e.g., 'flowchart', 'sequence', 'erd')")
    description: Optional[str] = Field(None, description="What to show in this diagram")
    framework: Optional[str] = Field(None, description="Preferred framework (mermaid, d2, plantuml)")
    details: Optional[str] = Field(None, description="Additional instructions for generation")

class DocumentationConfig(BaseModel):
    """Documentation generation configuration."""
    style: str = Field("technical", description="Documentation style")
    audience: str = Field("developers", description="Target audience")
    sections: List[str] = Field(default_factory=list, description="Sections to include")
    format: str = Field("mkdocs", description="Output format (mkdocs or markdown)")

class RecipeInstructions(BaseModel):
    """Instructions for diagram and documentation generation."""
    diagrams: List[DiagramRequest] = Field(..., min_items=1, description="Diagram specifications")
    documentation: Optional[DocumentationConfig] = Field(None, description="Documentation configuration")

class RecipeContent(BaseModel):
    """Complete recipe content structure for YAML files."""
    name: str = Field(..., pattern=r'^[a-zA-Z][a-zA-Z0-9_-]*$', min_length=1, max_length=100)
    prd: PRDContent
    instructions: RecipeInstructions

# MCP Tool Parameter Models - these use Pydantic for proper schema generation

class CreateRecipeParams(BaseModel):
    """Parameters for create_recipe tool."""
    name: Annotated[str, Field(
        pattern=r'^[a-zA-Z][a-zA-Z0-9_-]*$',
        min_length=1,
        max_length=100,
        description="Recipe name (used as filename)"
    )]
    prd_content: Annotated[Optional[str], Field(
        None,
        max_length=1048576,
        description="PRD content to embed in recipe (max 1MB)"
    )]
    prd_file_path: Annotated[Optional[str], Field(
        None,
        description="Path to external PRD file (alternative to prd_content)"
    )]
    diagrams: Annotated[List[DiagramRequest], Field(
        min_items=1,
        description="List of diagram specifications"
    )]
    documentation_config: Annotated[Optional[DocumentationConfig], Field(
        None,
        description="Optional documentation generation settings"
    )]
    output_dir: Annotated[str, Field(
        "./recipes",
        description="Directory to save the recipe file"
    )]

class EditRecipeParams(BaseModel):
    """Parameters for edit_recipe tool."""
    name: Annotated[str, Field(description="Recipe name to edit")]
    prd_content: Annotated[Optional[str], Field(None, description="New PRD content")]
    prd_file_path: Annotated[Optional[str], Field(None, description="New PRD file path")]
    diagrams: Annotated[Optional[List[DiagramRequest]], Field(None, description="New diagram specifications")]
    documentation_config: Annotated[Optional[DocumentationConfig], Field(None, description="New documentation settings")]
    validate_before_save: Annotated[bool, Field(True, description="Validate recipe before saving")]

class ValidateRecipeParams(BaseModel):
    """Parameters for validate_recipe tool."""
    name: Annotated[Optional[str], Field(None, description="Recipe name to validate from filesystem")]
    content: Annotated[Optional[RecipeContent], Field(None, description="Recipe content to validate directly")]

class DeleteRecipeParams(BaseModel):
    """Parameters for delete_recipe tool."""
    name: Annotated[str, Field(description="Recipe name to delete")]
    confirm: Annotated[bool, Field(
        False,
        description="Confirmation flag (must be true to delete)"
    )]
```

#### Processed Recipe Tool Models

```python
class DiagramSpecification(BaseModel):
    """Individual diagram specification with full details."""
    id: str = Field(..., description="Unique diagram identifier")
    type: str = Field(..., description="Diagram type")
    framework: str = Field(..., description="Target framework (mermaid, d2, plantuml)")
    agent: str = Field(..., description="Agent responsible for generation")
    title: str = Field(..., description="Diagram title")
    instructions: str = Field(..., min_length=10, description="Generation instructions")
    output_file: str = Field(..., description="Output file path")
    output_formats: List[str] = Field(..., description="Output formats (svg, png, pdf)")
    options: Optional[Dict[str, Any]] = Field(None, description="Framework-specific options")

class ContentFile(BaseModel):
    """Markdown content file specification."""
    id: str = Field(..., description="Content file identifier")
    path: str = Field(..., description="File path")
    type: str = Field(..., description="Content type (documentation, presentation)")
    agent: str = Field(..., description="Agent responsible for maintenance")
    base_prompt: str = Field(..., description="Base prompt for content generation")
    diagram_refs: List[str] = Field(default_factory=list, description="Referenced diagram IDs")
    title: Optional[str] = Field(None, description="Content title")
    last_updated: str = Field(..., description="ISO timestamp of last update")

class DiagramReference(BaseModel):
    """Reference to a generated diagram."""
    id: str = Field(..., description="Diagram identifier")
    title: str = Field(..., description="Diagram title")
    type: str = Field(..., description="Diagram type")
    expected_path: str = Field(..., description="Expected output path")
    status: str = Field(..., description="Generation status")

class OutputConfig(BaseModel):
    """Output configuration for generated assets."""
    assets_dir: str = Field(..., description="Directory for generated assets")
    mkdocs: Optional[Dict[str, Any]] = Field(None, description="MkDocs configuration")
    marp: Optional[Dict[str, Any]] = Field(None, description="Marp presentation config")

class ProcessedRecipeContent(BaseModel):
    """Complete processed recipe structure."""
    name: str = Field(..., pattern=r'^[a-zA-Z][a-zA-Z0-9_-]*$')
    version: str = Field(..., pattern=r'^\d+\.\d+\.\d+$')
    source_recipe: str = Field(..., description="Source user recipe path")
    generated_at: str = Field(..., description="ISO timestamp")
    content_files: List[ContentFile] = Field(..., min_items=1)
    diagram_specs: List[DiagramSpecification] = Field(..., min_items=1)
    diagram_refs: List[DiagramReference] = Field(..., min_items=1)
    outputs: OutputConfig
    generation_notes: Optional[List[str]] = Field(None, description="Generation notes")

# MCP Tool Parameters for Processed Recipes

class WriteProcessedRecipeParams(BaseModel):
    """Parameters for write_processed_recipe tool (existing in MCP server)."""
    recipe_path: Annotated[str, Field(
        description="Path to save the processed recipe (usually recipe.t2d.yaml)"
    )]
    content: Annotated[ProcessedRecipeContent, Field(
        description="Complete processed recipe content"
    )]
    validate: Annotated[bool, Field(
        True,
        description="Validate before writing"
    )]

class UpdateProcessedRecipeParams(BaseModel):
    """Parameters for update_processed_recipe tool."""
    recipe_path: Annotated[str, Field(
        description="Path to the processed recipe file to update"
    )]
    diagram_specs: Annotated[Optional[List[DiagramSpecification]], Field(
        None,
        description="Updated diagram specifications"
    )]
    content_files: Annotated[Optional[List[ContentFile]], Field(
        None,
        description="Updated content file specifications"
    )]
    diagram_refs: Annotated[Optional[List[DiagramReference]], Field(
        None,
        description="Updated diagram references"
    )]
    outputs: Annotated[Optional[OutputConfig], Field(
        None,
        description="Updated output configuration"
    )]
    generation_notes: Annotated[Optional[List[str]], Field(
        None,
        description="Additional generation notes"
    )]
    validate: Annotated[bool, Field(
        True,
        description="Validate after update"
    )]

class ValidateProcessedRecipeParams(BaseModel):
    """Parameters for validate_processed_recipe tool."""
    recipe_path: Annotated[Optional[str], Field(
        None,
        description="Path to processed recipe file to validate"
    )]
    content: Annotated[Optional[ProcessedRecipeContent], Field(
        None,
        description="Processed recipe content to validate directly"
    )]
```

#### Validation Models

```python
class ValidationError(BaseModel):
    """Validation error detail."""
    field: str = Field(..., description="Field path that failed validation")
    message: str = Field(..., description="Error message")
    error_type: str = Field(..., description="Error category")
    suggestion: Optional[str] = Field(None, description="How to fix the error")

class ValidationResult(BaseModel):
    """Result of recipe validation."""
    valid: bool
    errors: List[ValidationError] = Field(default_factory=list)
    warnings: List[str] = Field(default_factory=list)
    validated_at: str = Field(..., description="ISO timestamp")
    duration_ms: float = Field(..., description="Validation duration in milliseconds")
```

#### Operation Result Models

```python
class FileOperationResult(BaseModel):
    """Result of a file operation."""
    success: bool
    operation: str = Field(..., description="create, edit, delete, validate")
    file_path: Optional[str] = None
    message: str
    details: Optional[Dict[str, Any]] = None

class CreateRecipeResponse(BaseModel):
    """Response after creating a recipe."""
    success: bool
    recipe_name: str
    file_path: str
    validation_result: ValidationResult
    message: str

class EditRecipeResponse(BaseModel):
    """Response after editing a recipe."""
    success: bool
    recipe_name: str
    file_path: str
    changes_applied: Dict[str, Any]
    validation_result: Optional[ValidationResult]
    message: str

class DeleteRecipeResponse(BaseModel):
    """Response after deleting a recipe."""
    success: bool
    recipe_name: str
    file_path: str
    message: str
```

## State Transitions

### Recipe Lifecycle States

```
┌─────────┐      Create       ┌─────────┐
│  None   │ ──────────────────>│  Draft  │
└─────────┘                    └─────────┘
                                    │
                                    │ Validate
                                    ▼
                               ┌─────────┐
                               │  Valid  │
                               └─────────┘
                                    │
                                    │ Edit
                                    ▼
                               ┌─────────┐
                               │Modified │
                               └─────────┘
                                    │
                                    │ Delete
                                    ▼
                               ┌─────────┐
                               │ Deleted │
                               └─────────┘
```

## Validation Rules

### Recipe Name Validation
- Must start with a letter
- Can contain letters, numbers, hyphens, underscores
- Length: 1-100 characters
- Must be unique in the recipe directory

### PRD Content Validation
- Either `content` or `file_path`, not both
- Content max size: 1MB
- File path must exist and be readable
- Supported formats: markdown, text

### Diagram Validation
- At least one diagram required
- Type must be from available diagram types
- Framework must be compatible with type
- Description recommended for clarity

### File Size Validation
- Maximum recipe file size: 1MB
- Checked on read and write operations

### YAML Structure Validation
- Must be valid YAML syntax
- Must conform to recipe schema
- All required fields present
- No unknown top-level fields

## Relationships

```
DiagramTypesResource
    └── DiagramTypeInfo (1:N)

RecipeListResource
    └── RecipeSummary (1:N)

RecipeDetailResource
    ├── RecipeSummary (1:1)
    └── ValidationResult (0:1)

CreateRecipeRequest
    ├── PRDContent (1:1)
    └── DiagramRequest (1:N)

CreateRecipeResponse
    └── ValidationResult (1:1)

ValidationResult
    └── ValidationError (0:N)
```

## Performance Constraints

- Resource loading: < 100ms
- Recipe validation: < 200ms
- File operations: < 100ms
- Resource scanning: < 500ms for up to 1000 recipes

## Data Persistence

All data is persisted as YAML files in the filesystem:
- Default recipe directory: `./recipes/`
- File naming: `{recipe_name}.yaml` or `{recipe_name}.yml`
- Metadata extracted from file system (creation time, modification time, size)

## MCP Tool Implementation Pattern

Using Pydantic models as parameters ensures proper schema generation for MCP clients:

```python
from fastmcp import FastMCP, Context
from typing import Optional

mcp = FastMCP(
    name="t2d-kit Recipe Manager",
    description="""
    MCP server for t2d-kit recipe management.

    Resources:
    - diagram-types:// - Discover available diagram types
    - recipes:// - Browse existing recipes
    - recipe-schema:// - Get recipe YAML schema

    Tools:
    - create_recipe - Create new recipe files with validation
    - edit_recipe - Modify existing recipes
    - validate_recipe - Check recipe validity
    - delete_recipe - Remove recipe files
    """
)

@mcp.tool(
    description="Create a new t2d-kit recipe file. The tool validates the recipe and saves it as a YAML file."
)
async def create_recipe(params: CreateRecipeParams, ctx: Context) -> CreateRecipeResponse:
    """Create a new recipe with proper validation.

    The use of Pydantic model (CreateRecipeParams) ensures:
    1. MCP clients receive full JSON schema for parameters
    2. Automatic validation of input parameters
    3. Clear error messages for invalid inputs
    4. Type safety and auto-completion in IDEs
    """
    await ctx.info(f"Creating recipe: {params.name}")

    # Build recipe content from params
    recipe = RecipeContent(
        name=params.name,
        prd=PRDContent(
            content=params.prd_content,
            file_path=params.prd_file_path
        ),
        instructions=RecipeInstructions(
            diagrams=params.diagrams,
            documentation=params.documentation_config
        )
    )

    # Validate and save...
    return CreateRecipeResponse(
        success=True,
        recipe_name=params.name,
        file_path=f"{params.output_dir}/{params.name}.yaml",
        validation_result=ValidationResult(valid=True, duration_ms=45),
        message="Recipe created successfully"
    )

@mcp.tool(
    description="Edit an existing recipe file. Updates specified fields and validates before saving."
)
async def edit_recipe(params: EditRecipeParams, ctx: Context) -> EditRecipeResponse:
    """Edit existing recipe with validation."""
    # Implementation using Pydantic models
    pass

@mcp.tool(
    description="Validate a recipe file or content. Returns detailed validation results."
)
async def validate_recipe(params: ValidateRecipeParams, ctx: Context) -> ValidationResult:
    """Validate recipe content or file."""
    # Implementation using Pydantic validation
    pass
```

### Benefits of Using Pydantic Models

1. **Schema Discovery**: MCP clients automatically receive complete JSON schemas
2. **Type Safety**: Parameters are strongly typed and validated
3. **Documentation**: Field descriptions appear in tool schemas for LLMs
4. **Validation**: Automatic validation with clear error messages
5. **Nested Structures**: Complex nested data structures are fully supported
6. **IDE Support**: Auto-completion and type hints in development